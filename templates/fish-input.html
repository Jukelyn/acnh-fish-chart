<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ACNH Fish Spawning Calendar</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />

    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
  </head>
  <body>
    <div class="topnav">
      <a href="/">Home</a>
      <a class="active" href="/fish-input">Input Data</a>
    </div>

    <h1>Enter the fish you have caught (one per line):</h1>
    <div class="flex-wrap display: flex-wrap" style="text-align: center">
      <textarea
        autofocus
        id="fishData"
        placeholder="Type here..."
        rows="5"
        cols="50"
        style="resize: none; display: block; margin: 0 auto"
      ></textarea>
      <div
        style="
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-top: 10px;
        "
      >
        <button onclick="saveAndSendData();" class="button_container">
          Send input
        </button>
        <button onclick="clearCache();" class="button_container">
          Clear Cache
        </button>
      </div>
    </div>
    <div id="suggestions-container" style="display: none">
      <h2>You entered some invalid fish names</h2>
      These are the invalid names:
      <ul id="invalid-fish-list"></ul>
      Did you mean...
      <ul id="suggestions-list"></ul>
    </div>

    <script>
      function saveAndSendData() {
        let newData = document.getElementById("fishData").value;
        let existingData = localStorage.getItem("userInput");
        let data;

        if (existingData) {
          let existingDataArray = existingData.split("\n");
          let newDataArray = newData.split("\n");
          let combinedDataArray = [
            ...new Set([...existingDataArray, ...newDataArray]),
          ];
          data = combinedDataArray.join("\n");
        } else {
          data = newData;
        }

        localStorage.setItem("userInput", data); // Stores data in the browser
        console.log("Data saved in browser storage!");

        fetch("/process", {
          method: "POST",
          headers: {
            "Content-Type": "text/plain",
          },
          body: data,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Flask response: ", data);
            if (data.invalid_fish_names && data.suggestions) {
              displaySuggestions(data.invalid_fish_names, data.suggestions);
            }
          })
          .catch((error) => {
            // SyntaxError happens when all entries are valid... or so I hope...
            if (error instanceof SyntaxError) {
              console.error("SyntaxError:", error);
              window.location.href = "/";
            } else {
              console.error("Error:", error);
            }
          });
      }

      function displaySuggestions(invalidFish, suggestions) {
        const invalidFishList = document.getElementById("invalid-fish-list");
        const suggestionsList = document.getElementById("suggestions-list");
        const suggestionsContainer = document.getElementById(
          "suggestions-container"
        );

        invalidFishList.innerHTML = "";
        suggestionsList.innerHTML = "";

        invalidFish.forEach((fish) => {
          const li = document.createElement("li");
          li.textContent = fish;
          invalidFishList.appendChild(li);
        });

        suggestions.forEach((suggestion) => {
          const li = document.createElement("li");
          li.textContent = suggestion;
          suggestionsList.appendChild(li);
        });

        suggestionsContainer.style.display = "block";
      }

      function clearCache() {
        localStorage.removeItem("userInput");
        console.log("Cache cleared!");
      }
    </script>
  </body>
</html>
